# 11.1 단일 모델의 단점

- 주문 내역 조회 기능을 구현하기 위해 여러 애그리거트에서 데이터를 가져와야 한다.
  - Order (주문정보), Product (상품 이름), Member (회원 이름, ID)
- 조회 화면 특성상 조회 속도가 빠를 수록 좋은데 여러 애그리거트의 데이터가 필요하면 구현 방법을 고민해야함
  - 식별자를 이용한 애그리거트 참조 방식은 즉시 로딩과 같은 JPA 쿼리 최적화 기능을 사용할 수 없음.
  - 애그리거트 간 직접 참조를 사용하면 조회 화면 특성에 따른 같은 연관이라도 지연 로딩으로 처리해야 한다.
- 위와 같은 고민을 하는 이유는 시스템 상태를 변경할 때와 조회할 때 `단일 도메인 모델`을 사용하기 때문이다.
  - 여러 애그리거트에서 데이터를 가져와서 출력하는 기능을 구현하려면 고려할게 많아 구현을 복잡하게 만든다.
  - 이러한 구현 복잡도를 낮추는 간단한 방법은 상태 변경을 위한 모델과 조회를 위한 모델을 분리하는 것이다.

# 11.2 CQRS

- 시스템이 제공하는 기능은 크게 2가지로 나눌 수 있다.
  - 상태를 변경하는 기능
    - ex) 새로운 주문을 생성, 배송지 정보 변경, 회원 암호를 변경하는 기능
  - 사용자 입장에서 상태 정보를 조회하는 기능
    - ex) 주문 상세 내역 보기, 게시글 목록 보기, 회원 정보 보기, 판매 통계 보기
- 도메인 모델 관점에서 상태 변경 기능은 주로 한 애그리거트의 상태를 변경한다.
- 반면 조회 기능은 두 개 이상의 애그리거트가 필요할 때가 많다.
- 상태 변경 범위와 상태 조회 범위가 정확하게 일치하지 않아서 단일 모델로 두 종류의 기능을 구현하는 모델이 불필요하게 복잡해 진다.
  - 단일 모델을 사용할 때 발생하는 복잡도를 해결하기 위해 사용하는 방법이 바로 CQRS 이다.
- CQRS (Command Query Responsibility Segregation)
  - 상태를 변경하는 명령 (Command) 을 위한 모델과 상태를 제공하는 조회 (Query) 를 위한 모델을 분리하는 패턴이다.
  - 복잡한 도메인에 적합하다.
    - 도메인이 복잡할 수록 명령 기능과 조회 기능이 다루는 데이터 범위에 차이가 난다.
    - 이 두 기능을 단일 모델로 처리하면 조회 기능의 로딩 속도를 위해 모델 구현이 필요 이상으로 복잡해진다.
      - JPA 기반 단일 도메인 모델을 사용하면 통계 값을 빠르게 조회하기 위해 JPA 와 관련된 다양한 성능 관련 기능 모델을 적용해야 한다.
      - 이 상황에서 CQRS 를 적용하면 통계를 위한 조회 모델을 별도로 만들기 때문에 조회 기능 떄문에 도메인 모델이 복잡해지는 것을 막을 수 있다.

- CQRS 를 사용하면 각 모델에 맞는 구현 기술을 선택할 수 있다.
  - 명령 모델은 객체 지향에 기반해서 도메인 모델을 구현하기에 적당한 JPA 를 사용해서 구현한다.
  - 조회 모델은 DB 테이블에서 SQL 로 데이터를 조회할 때 좋은 마이바티스를 사용해서 구현하면 된다.
- 조회 모델을 따로 만들면 응용 서비스를 사용하지 않아도 된다.
  - 단순히 데이터를 읽어와 조회하는 기능은 응용 로직이 복잡하지 않으므로 컨트롤러에서 DAO 를 실행해도 무방하다.
  - 필요에 따라 응용 로직이 필요하다면 응용 서비스를 두고 로직을 구현하면 된다.
- 명령 모델과 조회모델이 서로 다른 데이터 저장소를 사용할 수도 있다.
  - 명령 모델은 트랜잭션을 지원하는 RDBMS 를 사용하고, 조회 모델은 조회 성능이 좋은 메모리 기반 NoSQL 을 사용할 수 있다.
  - 두 데이터 저장소 간 데이터 동기화는 10장에서 배운 이벤트를 활용해서 처리한다.
    - 명령 모델에서 상태를 변경하면 해당 이벤트가 발생하고 그 이벤트를 조회 모델에 전달해서 변경 내역을 반영하면 된다.
    - 데이터 동기화 시점에 따라 구현방식이 달라진다.
      - 명령 모델에서 데이터가 바뀌자마자 변경 내역을 바로 조회 모델에 반영해야 한다면 동기 이벤트와 글로벌 트랜잭션을 사용해서 실시간 동기화할 수 있다.
        - 하지만 글로벌 트랜잭션을 사용하면 전반적인 성능 (응답 속도와 처리량)이 떨어지는 단점이 있다.
      - 특정 시간안에만 동기화 해도 된다면 비동기로 데이터를 전송하면 된다.

```
CQRS 를 구현하기 위한 필수 기술이 따로 존재하는 건 아님. JPA 만 사용하더라도 명령 모델을 JPA 로 구현하고 조회 모델은 직접 SQL 을 사용해서 구현할 수 있다.
```

## 11.2.1 웹과 CQRS
- 일반적인 웹 서비스는 상태 변경 요청보다 상태 조회 요청이 많다.
  - 포털이나 대형 온라인 쇼핑몰 같이 조회 기능 요청 비율이 월등히 높은 서비스를 만드는 개발 팀은 조회 성능을 높이기 위한 다양한 기법을 사용한다.
    - 쿼리 최적화를 통한 쿼리 실행 속도 자체를 높인다.
    - 메모리에 조회 데이터를 캐싱 해서 응답 속도를 높인다.
    - 조회 전용 저장소를 따로 사용하기도 한다.
      - 이러한 다양한 기법을 사용하는 것은 결과적으로 CQRS 를 적용하는 것과 같은 효과이다.

## 11.2.2 CQRS 장단점
- 장점
  - 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다.
    - 복잡한 도메인 -> 상태 변경 로직이 복잡 -> 조회 모델과 명령 모델 분리를 통해 조회 성능을 위한 코드가 명령 모델에서 사라짐 -> 도메인 로직에 집중할 수 있고 명령 모델의 복잡도가 낮아짐.
  - 조회 성능 향샹 시키는데 유리하다.
    - 조회 단위로 캐시를 적용한다.
    - 조회에 특화된 쿼리를 마음대로 사용할 수 있다.
    - 조회 전용 저장소를 통해 조회 처리량을 대폭 늘릴 수도 있다.
  - 조회 성능을 높이기 위한 코드가 명령 모델에 영향을 주지 않는다.
    
- 단점 
  - 구현해야할 코드가 많아짐.
    - 다른 구현 기술을 사용하므로 각 구현 비용을 고려해야 한다.
    - 도메인이 단순하거나 트래픽이 많지 않으면 조회 전용 모델을 따로 만들때의 이점이 있는지 따져야 함.
  - 더 많은 구현 기술이 필요함.
    - 명령 모델과 조회 모델을 구분함에 따라 다른 저장소를 사용할 수도 있고 데이터 동기화를 위해 메시징 시스템을 도입해야할 수도 있음.


- 이러한 장단점을 고려하여 CQRS 도입을 결정해야 한다.
- 도메인이 단순한데 CQRS 도입 비용만 높아지고 얻을 수 있는 이점은 없다.
- 반대로 트래픽이 높은 서비스인데 단일 모델만 고집하면 오히려 비용이 높아질 수 있으므로 CQRS 도입을 고려하자.
