# 애그리거트 트랜잭션 관리

## 8.1 애그리거트와 트랜잭션

- 일관성이 깨지지 않도록 트랜잭션 처리하자
- 선점(비관적) 잠금, 비선점(낙관적) 잠금

## 선점 잠금

- 먼저 애그리거트를 구한 스레드가 애그리거트 사용이 끝날 때까지 다른 스레드가 해당 애그리거트를 수정하지 못하게 막는 방식
    - 애그리거트 구할때부터 커밋까지 블로킹
- DBMS 행단위 잠금
    - JPA에서 @Lock 등 사용으로 지정 가능
- 교착 상태 가능성 있음
    - 사용량 많을때 가능성 높아짐
    - 잠금 최대 대기 시간 지정 필요
    - DBMS 별 잠금 방식이 다름 (mysql 레코드 선점 잠금)

## 비선점 잠금

- 버전 정보로 쿼리 실행시 낙관적으로 확인
- JPA @Version
- 버전 정보를 클라이언트에게 줌, 버전 정보가 다르면 에러 처리
  - 응용서비스에서 처리?
- 애그리거트 내에 어떤 구성요소의 상태가 바뀌면 루트 애그리거트의 버전값이 증가해야 한다

## 오프라인 선점 잠금

- confluence에서 문서 편집중일때 다른 사람이 편집하면 안내 문구 보여줌
- 여러 트랜잭션에 걸쳐 동시 변경을 막는다
- flag 처리 비슷
- 잠금 유효시간 필요
